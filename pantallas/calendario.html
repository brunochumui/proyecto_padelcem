<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Canchas Pádel</title>
  <!-- FullCalendar CSS (cargar antes de tu CSS para que puedas sobreescribir) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
   <link rel="stylesheet" href="../calendario.css">
</head>
<body>
   <button class="volver-btn" id="volverBtn">Volver</button>
  <h2 class="titulo">Reservas de Canchas de Pádel</h2>
  <button id="reservarBtn" onclick="index.html">Pagar y confirmar reserva</button>
  <div id="calendar"></div>
 
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
  
  <script>
    const calendarEl = document.getElementById('calendar');
    let selectedSlot = null;
    let pagoCompletado = false;

const calendar = new FullCalendar.Calendar(calendarEl, {
  // Mostrar sólo UN DÍA a la vez; usar flechas para navegar entre días
  initialView: 'timeGridDay',
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'timeGridDay'
  },
  locale: 'es',
  selectable: true,
  allDaySlot: false,
  slotDuration: "01:30:00",
  slotLabelFormat: {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  },
  height: "auto",
  expandRows: true,
  events: [],
  // slotMin/Max se ajustan según el día visible en datesSet
  slotMinTime: "16:00:00",
  slotMaxTime: "24:00:00", /* ampliado por defecto: +1:30 */
  datesSet: function(info) {
    // Ajustar la franja visible según el día actual (cuando se cambia con prev/next)
    if (info.view.type !== 'timeGridDay') return;
    const day = new Date(info.start).getDay(); // 0=Dom,6=Sáb
    if (day === 0 || day === 6) {
      // fines: antes 16:00-22:00 -> ahora 16:00-23:30 (más 1:30)
      calendar.setOption('slotMinTime', '16:00:00');
      calendar.setOption('slotMaxTime', '23:30:00');
    } else {
      // lunes-viernes: antes 16:30-22:30 -> ahora 16:30-24:00 (más 1:30)
      calendar.setOption('slotMinTime', '16:30:00');
      calendar.setOption('slotMaxTime', '24:00:00');
    }
  },
  select: function(info) {
    // Obtener canchas desde la API y mostrar un modal de selección
    fetch('api.php')
      .then(res => res.json())
      .then(courts => {
        if (!Array.isArray(courts) || courts.length === 0) {
          alert('No hay canchas disponibles.');
          return;
        }

        const modal = document.createElement('div');
        Object.assign(modal.style, {
          position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          background: 'rgba(0,0,0,0.45)', zIndex: 9999
        });

        const box = document.createElement('div');
        Object.assign(box.style, {
          background: '#fff', padding: '18px', borderRadius: '8px',
          maxWidth: '420px', width: '90%', boxShadow: '0 6px 24px rgba(0,0,0,0.2)'
        });

        const title = document.createElement('h3');
        title.textContent = 'Elegí la cancha';
        box.appendChild(title);

       courts.forEach(court => {
          const id = court.ID_cancha;
          const tipo = court.Tipo;
          const precio = court.Precio_hora;
          const seña = 20000;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = `Cancha ${id} — ${tipo} — $${precio} (seña $${seña})`;
          Object.assign(btn.style, { display: 'block', width: '100%', margin: '8px 0', padding: '8px' });
          btn.addEventListener('click', () => {
            selectedSlot = { ...info, cancha: id, tipo: tipo, precio: precio };
            document.body.removeChild(modal);
            alert(`Horario seleccionado: ${info.startStr} a ${info.endStr}\nCancha: ${id}\nTipo: ${tipo}\nPrecio: $${precio}`);
          });

          box.appendChild(btn);
        });

        const cancel = document.createElement('button');
        cancel.type = 'button';
        cancel.textContent = 'Cancelar';
        Object.assign(cancel.style, { display: 'block', width: '100%', margin: '6px 0', padding: '8px', background: '#eee' });
        cancel.addEventListener('click', () => {
          selectedSlot = null;
          document.body.removeChild(modal);
        });
        box.appendChild(cancel);

        modal.appendChild(box);
        document.body.appendChild(modal);
      })
      .catch(err => {
        console.error(err);
        alert('Error al cargar las canchas.');
      });
  }
});
 
     calendar.render();

    document.getElementById("reservarBtn").addEventListener("click", async () => {
      if (!selectedSlot) {
        alert("Primero seleccioná un horario y una cancha en el calendario.");
        return;
      }
      // Mostrar resumen con precio/tipo antes de iniciar pago
      const resumen = `Vas a reservar Cancha ${selectedSlot.cancha}\nTipo: ${selectedSlot.tipo || '—'}\nPrecio: $${selectedSlot.precio || '—'}\n\nConfirmar y continuar al pago?`;
      if (!confirm(resumen)) return;
      const response = await fetch("http://localhost:8080/create_preference", { method: "POST" });
      const data = await response.json();
      if (data.link) {
        window.location.href = data.link;
      } else {
        alert("No se pudo generar el link de pago.");
        return;
      }

      setTimeout(() => {
        pagoCompletado = true;
        calendar.addEvent({
          title: `Cancha ${selectedSlot.cancha} Reservada`,
          start: selectedSlot.start,
          end: selectedSlot.end
        });
        alert("✅ Pago confirmado y reserva realizada!");
        selectedSlot = null;
      }, 5000);
    });

    document.getElementById("volverBtn").addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
